---
import type { GetStaticPaths } from "astro";
import { db } from "astro:db";
import { PYQs } from "astro:db";
import { eq } from "astro:db";
import type { ExplorerItem } from "@/types";
import FilesLister from "@/components/files_lister.astro";
import { and } from "astro:db";
import ExplorerLayout from "@/layouts/ExplorerLayout.astro";
import { getDirectDownloadLink, make_gApis_from_gDrvie_link } from "@/gdrive/gdrive_functions";
import { GOOGLE_DRIVE_API_KEY } from "astro:env/server";
import { toOrdinal } from "@/lib/text_manipulation/number_manipulation";

export const getStaticPaths = (async() => {
  const res = await db.selectDistinct({couse_name: PYQs.course_name, college: PYQs.college_short_name, semester: PYQs.semester ,  subject: PYQs.subject_short_name}).from(PYQs)
  
  return res.map(item=>({params: {college: item.college, course: item.couse_name.replaceAll(" ", "_"), semester: item.semester ,subject: item.subject }}));
}) satisfies GetStaticPaths;

const {college, course, semester, subject } = Astro.params

const res = await db.select({year: PYQs.year_released, gdrive_link: PYQs.google_drive_link}).from(PYQs).where(and(eq(PYQs.college_short_name, college), eq(PYQs.course_name, course.replaceAll("_", " ")), eq(PYQs.semester, semester), eq(PYQs.subject_short_name, subject ) ))

const base_url = import.meta.env.BASE_URL

const subjects: ExplorerItem[] = res.map(item => ({
  label: `${subject} ${item.year}`,
  link: `${base_url}/pyq/${college}/${course}/${semester}/${subject}/${item.year}`,
  type: "file",
  file_type: "pdf",
  download_link: getDirectDownloadLink(item.gdrive_link)||""
})) 

const breadcrumb_items = [
  {label: "Home", link: `${base_url}/`},
  {label: "PYQ", link:`${base_url}/pyq/`},
  {label: college.toUpperCase(), link: `${base_url}/pyq/${college}/`},
  {label: course.toUpperCase().replaceAll("_"," "), link:`${base_url}/pyq/${college}/${course}`},
  {label: toOrdinal( semester), link: `${base_url}/pyq/${college}/${course}/${semester}/` }
]
---
<ExplorerLayout label={`${subject.toUpperCase()} PYQs`} breadcrumb_items={breadcrumb_items} >
  <FilesLister items={subjects} />
</ExplorerLayout>

